---
title: Comparing `pak` and `Require`
output: html_document
editor_options: 
  chunk_output_type: console
---

# Principles used in `Require`

`Require` is desinged with features that facilitate running R code that is part of a continuous workflow, from data-to-decisions. For this to work, all functions called by a user should have a property whereby the initial time they are called does the heavy work, and the subsequent times are sufficiently fast that the user is not forced to skip over lines of code when re-running code. The package, `reproducible`, has a function `Cache` which can convert many function calls to have this property. It does not work well for functions whose objectives are side-effects, like installing and loading packages. `Require` fills this gap.

## Managing pacakges during code development

It is common during code development to work in teams, and to be updating package code. 

### All working on same project

If the whole team is working on the same "whole" project, then `renv` provides a mechanism for each team member to update code, then snapshot the project, commit the snapshot and push to the cloud for the team to share. 

### Diverse projects

However, if a team is more diversified and they are actually sharing the new code, but not the whole project, then project snapshots will be very inefficient. Instead, the code developer can work on their package, and the team members will have 2 options of what they might want to do: keep at the bleeding edge or update only if necessary for dependencies. More likely, they will want to have a mixture of these strategies, i.e., bleeding edge with some code, but only if necessary with others. `renv` does not easily allow this as it is an "project-level" approach. `pak` offers the ability at install time for a user to decide. `Require` on the other hand offers programmatic control for this. For example 

```{r,eval}
Install(c("PredictiveEcology/reproducible@development (HEAD)", 
          "PredictiveEcology/SpaDES.core@development (>=2.0.5.9004)")) 
```
will keep the project at the bleeding edge of the development branch of `reproducible`, but will only update if necessary (based on the version needed, expressed by the in) for the development branch of `SpaDES.core`. The user doesn't have to make decisions at run time as to whether an update should be made, and for which packages.

# How `Require` differs from other approaches

## Default behaviours different

### Packages that aren't yet installed 

| Description                      |  Outcome                                   |
| -------------------------------- | ------------------------------------------ |
| `Install("data.table")`          | `data.table` installed *if not installed*  |
| `install.packages("data.table")` | `data.table` installed                     |
| `pak::pkg_install("data.table")` | `data.table` installed *if not installed*  |
| `renv::install("data.table")`    | `data.table` installed                     |

### Already installed, but old

| Description                      |  Outcome                                   |
| -------------------------------- | ----------------------------------------------------------------- |
| `Install("data.table")`          | `data.table` not installed                                        |
| `install.packages("data.table")` | `data.table` installed, always, regardless of version             |
| `pak::pkg_install("data.table")` | `data.table` installed, asks user if wants to update if available |
| `renv::install("data.table")`    | `data.table` installed, asks user if wants to update if available |


# Differences and similarities between `pak` and `Require`

\\* Indicates that there is an example below.

| Description                      |  `Require`    |   `pak`                               |
| -------------------------------- | :------------------------------: | :-----------------------------------: |
| Archived package*                 | Automatic                                        | Not an option  | 
| Dependency conflicts*   | Yes   |  No (see example below)  |  
| Multiple requests of same package | Resolves by version number specification, or most recent version | Error |
| Control individual package updates | With `HEAD`   |   No   |
| Parallel downloads   |   with `options(Require.installPackagesSys = 2)`    |   Yes    |
| Parallel installs    |   with `options(Require.installPackagesSys = 2)`    |   Yes    |
| Very clean messaging   |   somewhat, with `options(Require.installPackagesSys = 1)`  | Yes    |  
| Package dependencies     |  0   |   `data.table` |
| Uses local cache   |   Yes   |   Yes   |
| Package updates (default)    | No, unless needed by version number | Yes, prompt user |     
| Package install by version    | Yes | No (only if declared in a `DESCRIPTION` file)  |   
| Package conflict (CRAN & GitHub) | Prefers CRAN, if version requirements met  |  Error  |

## Archived packages

`fastdigest` has been taken off CRAN. If this is part of *your* direct dependencies, you can remove it and find an alternative. However, if it is an indirect dependency, you don't have that choice. `Require` will just get the most recent archived copy and the work can continue.

```{r,eval=TRUE,message=FALSE}
Require::Install("fastdigest")

try(pak::pkg_install(c("fastdigest")))
```

## Dependency conflict

When doing code development, it is common to use many `GitHub` packages. Each of these may point to one or more `Remotes`, i.e., *other* GitHub packages. 
```{r, eval=TRUE,message=FALSE}

# Fails because of a) packages taken off CRAN & multiple GitHub branches requested
try(pk <- pak::pkg_deps("PredictiveEcology/LandR@LandWeb"))

# Fine
Require::pkgDep("PredictiveEcology/LandR@LandWeb")

```

```{r,eval=FALSE}
try(gg <- pak::pkg_deps("PredictiveEcology/LandR@development", dependencies = TRUE))
pkgDep("PredictiveEcology/LandR@development", dependencies = TRUE)
```



## Version requirements determine package installation

1. **Version number requirements** drive package updates. If a user doesn't need an update because version numbers are sufficient, no update will occur.

2. If no version number specification, then installs only occur if package is not present.

3. Multiple simultaneous requests to install a package will not create a conflict unless version requirements cause the conflict. If version number requirements are not specified, CRAN versions will take precedence.

```{r,eval=TRUE}
# The following has no version specifications, 
#   so CRAN version will be installed or none installed if already installed
Require::Install(c("PredictiveEcology/reproducible@development", "reproducible"))

# The following specifies "HEAD" after the Github package name. This means the 
#   tip of the development branch of reproducible will be installed if not already installed
Require::Install(c("PredictiveEcology/reproducible@development (HEAD)", "reproducible"))

# The following specifies "HEAD" after the package name. This means the 
#   tip of the development branch of reproducible
Require::Install(c("PredictiveEcology/reproducible@development", "reproducible (HEAD)"))

```


## pak
- when it fails due to "dependency conflict", it may be difficult to diagnose
- seems to work if there is only one "branch" for each given package, but not multiple branches e.g., `c("PredictiveEcology/reproducible@development", "PredictiveEcology/reproducible")`, but 
it is not clear why ... are their dependencies conflicting or is it just the package
- can't write version numbers at the command line, though they can exist in a DESCRIPTION file

```{r}

## FAILS
try(pak::pkg_install(
  c("PredictiveEcology/reproducible@development", 
    "PredictiveEcology/reproducible")))
# Error:                                                                                 
# ! error in pak subprocess
# Caused by error: 
# ! Could not solve package dependencies:
# * PredictiveEcology/reproducible@development: Conflicts with PredictiveEcology/reproducible
# * PredictiveEcology/reproducible: Conflicts with PredictiveEcology/reproducible@development
# Type .Last.error to see the more details.



## FAILS
try(pak::pkg_install(
    c("PredictiveEcology/reproducible@modsForLargeArchives (>=2.0.10.9010)",
      "PredictiveEcology/reproducible (>= 2.0.10)")))

## FAILS
try(pak::pkg_install("local://~/GitHub/Edehzhie/DESCRIPTION"))

# Installs or does nothing is `reproducible` already installed
Require::Install(
  c("PredictiveEcology/reproducible@development", 
    "PredictiveEcology/reproducible"))

# Fine -- picks the more recent version number and installs
Require::Install(
    c("PredictiveEcology/reproducible@modsForLargeArchives (>=2.0.10.9010)", 
      "PredictiveEcology/reproducible (>= 2.0.10)"))
```

## pak

Fails when there are 2 branches within a DESCRIPTION -- wants to downgrade, regardless of order
```{r}
# Installs or does nothing is `reproducible` already installed
Require::Install(
  c("PredictiveEcology/reproducible@development", 
    "PredictiveEcology/reproducible"))

DESC <- c("Package: temp", "Type: Package", "Title: Temp", "Version: 0.0.1", 
          "Description: Eliot McIntire", "Date: 2024-02-20", "Authors@R:  ", 
          "  NULL", "Imports:", "    reproducible", "Suggests:", "    knitr,", 
          "    rmarkdown", "Remotes:", "    PredictiveEcology/reproducible,", 
          "    PredictiveEcology/reproducible@development", "Encoding: UTF-8", 
          "License: GPL-3", "VignetteBuilder: knitr, rmarkdown", "ByteCompile: yes", 
          "Roxygen: list(markdown = TRUE)")
cat(DESC, file = "DESCRIPTION")
try(pak::local_install_deps("~/GitHub/Edehzhie/"))
                                                                                       
# → Will update 1 package.
# → All 2 packages (0 B) are cached.
# + reproducible 2.0.10.9018 → 2.0.10 [bld][cmp] (GitHub: 014d1de)



# Fails when adding the version number specification because internally trims the branch
DESC <- c("Package: temp", "Type: Package", "Title: Temp", "Version: 0.0.1", 
          "Description: Eliot McIntire", "Date: 2024-02-20", "Authors@R:  ", 
          "  NULL", "Imports:", "    reproducible (>= 2.0.10.9010)", "Suggests:", 
          "    knitr,", "    rmarkdown", "Remotes:", "    PredictiveEcology/reproducible,", 
          "    PredictiveEcology/reproducible@modsForLargeArchives", "Encoding: UTF-8", 
          "License: GPL-3", "VignetteBuilder: knitr, rmarkdown", "ByteCompile: yes", 
          "Roxygen: list(markdown = TRUE)")
cat(DESC, file = "DESCRIPTION")
try(pak::local_install_deps("~/GitHub/Edehzhie/"))
# Error:                                                                      
# ! error in pak subprocess
# Caused by error: 
# ! Could not solve package dependencies:
# * deps::C:/Eliot/GitHub/Edehzhie: Can't install dependency PredictiveEcology/reproducible (>= 2.0.10.9010)
# Type .Last.error to see the more details.
```

### Error handling

`pak` uses a different approach to error handling. Sometimes this can be effective. Other times it limits the ability to diagnose errors:
```{r,eval=FALSE}

# This package is not compiling correctly
> pak::pkg_install("fasterize")
✔ Loading metadata database ... done
                                                                           
→ Will update 1 package.
→ Will download 1 CRAN package (732.71 kB).
+ fasterize 1.0.4 → 1.0.5 [bld][cmp][dl] (732.71 kB)
✔ All system requirements are already installed.
  
? Do you want to continue (Y/n) Y
ℹ Getting 1 pkg (732.71 kB)
✔ Got fasterize 1.0.5 (source) (732.71 kB)                                
✔ Downloaded 1 package (732.71 kB) in 726ms                               
ℹ Building fasterize 1.0.5
✖ Failed to build fasterize 1.0.5 (30.1s)                        
Error:                                                           
! error in pak subprocess
Caused by error in `stop_task_build(state, worker)`:
! Failed to build source package fasterize.
Type .Last.error to see the more details.
> .Last.error
<callr_error/rlib_error_3_0/rlib_error/error>
Error: 
! error in pak subprocess
Caused by error in `stop_task_build(state, worker)`:
! Failed to build source package fasterize.
---
Backtrace:
1. pak::pkg_install("fasterize")
2. pak:::remote(function(...) get("pkg_install_do_plan", asNamespace("pak"))(...), …
3. err$throw(res$error)
---
Subprocess backtrace:
 1. base::withCallingHandlers(cli_message = function(msg) { …
 2. get("pkg_install_do_plan", asNamespace("pak"))(...)
 3. proposal$install()
 4. pkgdepends::install_package_plan(plan, lib = private$library, num_workers = nw, …
 5. base::withCallingHandlers({ …
 6. pkgdepends:::handle_events(state, events)
 7. pkgdepends:::handle_event(state, i)
 8. pkgdepends:::stop_task(state, worker)
 9. pkgdepends:::stop_task_build(state, worker)
10. base::throw(pkg_error("Failed to build source package {.pkg {pkg}}.", …
11. | base::signalCondition(cond)
12. global (function (e) …
```

## Incorrectly attempts to install binary packages from Posit Package Manager when these should not be

```{r,eval=FALSE}
pak::pkg_install("ianmseddy/PSPclean@development")
✔ Updated metadata database: 6.09 MB in 9 files.                           
✔ Updating metadata database ... done                                     
                                                                           
→ Will install 24 packages.
→ All 24 packages (0 B) are cached.
+ classInt       0.4-10     
+ crayon         1.5.2      
+ data.table     1.15.4     
+ DBI            1.2.2      
+ digest         0.6.35     
+ e1071          1.7-14     
+ filelock       1.0.3      
+ fpCompare      0.2.4      
+ fs             1.6.3       + ✔ make
+ lobstr         1.1.2      
+ magrittr       2.0.3      
+ prettyunits    1.2.0      
+ proxy          0.4-27     
+ PSPclean       0.1.4.9005 [bld][cmp] (GitHub: f12d524)
+ raster         3.6-26     
+ Rcpp           1.0.12     
+ reproducible   2.0.11     
+ rlang          1.1.3      
+ s2             1.1.6       + ✔ libssl-dev
+ sf             1.0-16      + ✔ libgdal-dev, ✔ gdal-bin, ✔ libgeos-dev, ✔ libproj-dev, ✔ libsqlite3-dev
+ sp             2.1-3      
+ terra          1.7-71      + ✔ libgdal-dev, ✔ gdal-bin, ✔ libgeos-dev, ✔ libproj-dev, ✔ libsqlite3-dev
+ units          0.8-5       + ✔ libudunits2-dev
+ wk             0.9.1      
✔ All system requirements are already installed.
  
ℹ No downloads are needed, 24 pkgs are cached
✔ Got filelock 1.0.3 (x86_64-pc-linux-gnu-ubuntu-22.04) (24.25 kB)
✔ Got DBI 1.2.2 (x86_64-pc-linux-gnu-ubuntu-22.04) (890.85 kB)
✔ Got classInt 0.4-10 (x86_64-pc-linux-gnu-ubuntu-22.04) (497.59 kB)
✔ Got lobstr 1.1.2 (x86_64-pc-linux-gnu-ubuntu-22.04) (132.05 kB)
✔ Got fs 1.6.3 (x86_64-pc-linux-gnu-ubuntu-22.04) (288.29 kB)
✔ Got digest 0.6.35 (x86_64-pc-linux-gnu-ubuntu-22.04) (217.34 kB)
✔ Got PSPclean 0.1.4.9005 (source) (43.21 kB)
✔ Got prettyunits 1.2.0 (x86_64-pc-linux-gnu-ubuntu-22.04) (154.92 kB)
✔ Got Rcpp 1.0.12 (x86_64-pc-linux-gnu-ubuntu-22.04) (2.15 MB)
✔ Got magrittr 2.0.3 (x86_64-pc-linux-gnu-ubuntu-22.04) (221.09 kB)
✔ Got crayon 1.5.2 (x86_64-pc-linux-gnu-ubuntu-22.04) (159.79 kB)
✔ Got data.table 1.15.4 (x86_64-pc-linux-gnu-ubuntu-22.04) (2.18 MB)
✔ Got rlang 1.1.3 (x86_64-pc-linux-gnu-ubuntu-22.04) (1.55 MB)
✔ Got raster 3.6-26 (x86_64-pc-linux-gnu-ubuntu-22.04) (3.33 MB)
✔ Got fpCompare 0.2.4 (x86_64-pc-linux-gnu-ubuntu-22.04) (19.92 kB)
✔ Got e1071 1.7-14 (x86_64-pc-linux-gnu-ubuntu-22.04) (589.71 kB)
✔ Got s2 1.1.6 (x86_64-pc-linux-gnu-ubuntu-22.04) (2.17 MB)
✔ Got sp 2.1-3 (x86_64-pc-linux-gnu-ubuntu-22.04) (2.09 MB)
✔ Got reproducible 2.0.11 (x86_64-pc-linux-gnu-ubuntu-22.04) (947.52 kB)
✔ Got proxy 0.4-27 (x86_64-pc-linux-gnu-ubuntu-22.04) (174.07 kB)
✔ Got wk 0.9.1 (x86_64-pc-linux-gnu-ubuntu-22.04) (1.72 MB)
✔ Got sf 1.0-16 (x86_64-pc-linux-gnu-ubuntu-22.04) (3.56 MB)
✔ Got terra 1.7-71 (x86_64-pc-linux-gnu-ubuntu-22.04) (4.24 MB)
✔ Got units 0.8-5 (x86_64-pc-linux-gnu-ubuntu-22.04) (354.95 kB)
✔ Installed DBI 1.2.2  (102ms)                                                                                               
✔ Installed classInt 0.4-10  (105ms)                                                                                         
✔ Installed crayon 1.5.2  (132ms)                                                                                          
✔ Installed data.table 1.15.4  (146ms)                                                                                
✔ Installed digest 0.6.35  (176ms)                                                                          
✔ Installed e1071 1.7-14  (186ms)                                                                   
✔ Installed filelock 1.0.3  (193ms)                                                     
✔ Installed Rcpp 1.0.12  (306ms)                                                
✔ Installed fpCompare 0.2.4  (36ms)                                          
✔ Installed fs 1.6.3  (23ms)                                               
✔ Installed lobstr 1.1.2  (13ms)                                    
✔ Installed magrittr 2.0.3  (38ms)                                    
✔ Installed prettyunits 1.2.0  (16ms)                                    
✔ Installed proxy 0.4-27  (27ms)                                       
✔ Installed raster 3.6-26  (38ms)                                   
✔ Installed reproducible 2.0.11  (22ms)                                   
✔ Installed rlang 1.1.3  (26ms)                                         
✔ Installed s2 1.1.6  (36ms)                                     
✔ Installed sf 1.0-16  (56ms)                                   
✔ Installed sp 2.1-3  (40ms)                                    
✔ Installed terra 1.7-71  (99ms)                                   
✔ Installed units 0.8-5  (18ms)                                    
✔ Installed wk 0.9.1  (30ms)                                     
ℹ Packaging PSPclean 0.1.4.9005                                 
✔ Packaged PSPclean 0.1.4.9005 (516ms)                              
ℹ Building PSPclean 0.1.4.9005                                      
✖ Failed to build PSPclean 0.1.4.9005 (3.8s)                        
Error:                                                              
! error in pak subprocess
Caused by error in `stop_task_build(state, worker)`:
! Failed to build source package PSPclean.
Type .Last.error to see the more details.
Timing stopped at: 3.321 0.093 19.32
> .Last.error
<callr_error/rlib_error_3_0/rlib_error/error>
Error: 
! error in pak subprocess
Caused by error in `stop_task_build(state, worker)`:
! Failed to build source package PSPclean.
---
Backtrace:
1. base::system.time(pak::pkg_install("ianmseddy/PSPclean@development"))
2. pak::pkg_install("ianmseddy/PSPclean@development")
3. pak:::remote(function(...) get("pkg_install_do_plan", asNamespace("pak"))(...), …
4. err$throw(res$error)
---
Subprocess backtrace:
 1. base::withCallingHandlers(cli_message = function(msg) { …
 2. get("pkg_install_do_plan", asNamespace("pak"))(...)
 3. proposal$install()
 4. pkgdepends::install_package_plan(plan, lib = private$library, num_workers = nw, …
 5. base::withCallingHandlers({ …
 6. pkgdepends:::handle_events(state, events)
 7. pkgdepends:::handle_event(state, i)
 8. pkgdepends:::stop_task(state, worker)
 9. pkgdepends:::stop_task_build(state, worker)
10. base::throw(pkg_error("Failed to build source package {.pkg {pkg}}.", …
11. | base::signalCondition(cond)
12. global (function (e) …

            
Install("ianmseddy/PSPclean@development")
```


## renv
- doesn't install packages that have been removed from CRAN (SpaDES)
- finds packages that other package dependencies don't find (SpaDES.docs)
- slow to download
- hijack
- when fails, can't pick up where it left off
- fails to install e.g., reproducible if it insufficient version, even if nothing is loaded
- relies so heavily on DESCRIPTION that e.g., `install.packages("reproducible")` will not install
reproducible from CRAN if there is a `Remotes` pointing to e.g., `PredictiveEcology/reproducible@reproducibleTempCacheDir`


# These are not the same ... why?
bb <- c("DEoptim", "PredictiveEcology/LandR@development (>= 1.1.0.9074)",
        "ianmseddy/LandR.CS@master (>= 0.0.2.0002)", "MASS", "Matrix",
        "ianmseddy/PSPclean@development (>= 0.1.3.9003)", "R.utils",
        "RCurl", "Rcpp", "PredictiveEcology/Require@development (>= 0.3.1)",
        "RhpcBLASctl", "PredictiveEcology/SpaDES.core@optionsAsArgs (>= 2.0.2.9010)",
        "PredictiveEcology/SpaDES.project@transition (>= 0.0.8.9026)",
        "PredictiveEcology/SpaDES.tools@development (>= 2.0.4.9002)",
        "XML", "archive", "assertthat", "PredictiveEcology/climateData@development (>= 1.0.5)",
        "compiler", "crayon", "data.table (>= 1.15.0)", "digest", "disk.frame",
        "dplyr", "fastDummies", "fastdigest", "fasterize", "PredictiveEcology/fireSenseUtils@development (>= 0.0.5.9056)",
        "fpCompare", "future", "geodata", "ggplot2", "ggpubr", "googledrive",
        "grid", "gridExtra", "kSamples", "logging", "magrittr", "merTools",
        "methods", "mgcv", "nlme", "numDeriv", "parallel", "parallelly",
        "PredictiveEcology/pemisc@development (>= 0.0.3.9002)", "plyr",
        "pryr", "purrr", "quickPlot", "raster", "rasterVis", "PredictiveEcology/reproducible@reproducibleTempCacheDir (>= 2.0.8.9012)",
        "robustbase", "scales", "sf", "snow", "sp", "spatialEco", "stats",
        "terra", "tidyr", "viridis")
a <- pkgDep(bb, recursive = TRUE)
b <- unlist(lapply(bb, pkgDep, recursive = TRUE), recursive = FALSE)
all.equal(b$`PredictiveEcology/LandR@development (>= 1.1.0.9074)`, a$`PredictiveEcology/LandR@development (>= 1.1.0.9074)`)






bbb <- list(canClimateData = c("SpaDES.core", "archive", "digest", "geodata",
                               "googledrive", "PredictiveEcology/climateData@development (>= 1.0.5)",
                               "PredictiveEcology/fireSenseUtils@development (>= 0.0.5.9046)",
                               "PredictiveEcology/LandR@development (>= 1.1.0.9064)", "PredictiveEcology/reproducible@development (>= 2.0.8.9001)",
                               "PredictiveEcology/SpaDES.tools@development (>= 2.0.4.9002)",
                               "purrr", "R.utils", "sf", "spatialEco", "terra"),
            fireSense_dataPrepFit = c("data.table (>= 1.15.0)",
                                      "fastDummies", "ggplot2", "parallel", "PredictiveEcology/fireSenseUtils@development (>= 0.0.5.9056)",
                                      "PredictiveEcology/LandR@development (>= 1.1.0.9073)", "PredictiveEcology/SpaDES.core@development (>= 2.0.2.9006)",
                                      "PredictiveEcology/SpaDES.project@transition", "PredictiveEcology/SpaDES.tools (>= 2.0.4.9002)",
                                      "purrr", "raster", "sf", "snow", "sp", "spatialEco", "terra"),
            Biomass_borealDataPrep = c("assertthat", "crayon", "data.table",
                                       "dplyr", "fasterize", "ggplot2", "merTools", "plyr", "PredictiveEcology/LandR@development (>= 1.1.0.9054)",
                                       "PredictiveEcology/pemisc@development", "PredictiveEcology/reproducible@development (>= 2.0.8.9005)",
                                       "PredictiveEcology/SpaDES.core@development (>= 2.0.2.9004)",
                                       "PredictiveEcology/SpaDES.project@transition (>= 0.0.8.9026)",
                                       "rasterVis", "sf", "SpaDES.tools (>= 2.0.0)", "terra"),
            Biomass_core = c("assertthat",
                             "compiler", "crayon", "data.table", "dplyr", "fpCompare",
                             "ggplot2", "grid", "ianmseddy/LandR.CS@master (>= 0.0.2.0002)",
                             "parallel", "PredictiveEcology/LandR@development (>= 1.1.0.9006)",
                             "PredictiveEcology/pemisc@development", "PredictiveEcology/reproducible@development",
                             "PredictiveEcology/SpaDES.core@development (>= 2.0.2.9004)",
                             "PredictiveEcology/SpaDES.tools@development (>= 1.0.0.9001)",
                             "purrr", "quickPlot", "R.utils", "Rcpp", "scales", "terra",
                             "tidyr"),
            Biomass_speciesData = c("data.table", "PredictiveEcology/LandR@development (>= 1.1.0.9074)",
                                    "PredictiveEcology/pemisc@development", "PredictiveEcology/reproducible@reproducibleTempCacheDir (>= 2.0.8.9012)",
                                    "PredictiveEcology/SpaDES.core@development (>= 2.0.2.9004)",
                                    "PredictiveEcology/SpaDES.tools@development (>= 1.0.2)",
                                    "pryr", "RCurl", "sf", "terra", "XML"),
            Biomass_speciesFactorial = c("crayon",
                                         "ggplot2", "PredictiveEcology/LandR@development (>= 1.0.7.9025)",
                                         "PredictiveEcology/SpaDES.core@optionsAsArgs (>= 2.0.2.9010)",
                                         "PredictiveEcology/SpaDES.project (>= 0.0.7.9013)", "terra",
                                         "viridis"),
            Biomass_speciesParameters = c("crayon", "data.table",
                                          "disk.frame", "fpCompare", "ggplot2", "gridExtra", "ianmseddy/PSPclean@development (>= 0.1.3.9003)",
                                          "magrittr", "mgcv", "nlme", "PredictiveEcology/LandR@development (>= 1.1.0.9054)",
                                          "PredictiveEcology/pemisc@development (>= 0.0.3.9002)", "PredictiveEcology/reproducible@development (>= 1.2.10.9001)",
                                          "PredictiveEcology/SpaDES.core@development (>= 2.0.2.9004)",
                                          "purrr", "robustbase", "sf"),
            fireSense_IgnitionFit = c("data.table",
                                      "DEoptim", "dplyr", "ggplot2", "ggpubr", "magrittr", "MASS",
                                      "numDeriv", "parallel", "parallelly", "PredictiveEcology/fireSenseUtils@terra-migration (>= 0.0.5.9045)",
                                      "PredictiveEcology/pemisc@development", "PredictiveEcology/reproducible@development (>= 2.0.8.9005)",
                                      "PredictiveEcology/SpaDES.core@development (>= 2.0.2.9006)",
                                      "RhpcBLASctl", "terra"),
            fireSense_EscapeFit = "SpaDES.core",
            fireSense_SpreadFit = c("SpaDES.core", "data.table", "DEoptim",
                                    "fastdigest", "future", "ggplot2", "kSamples", "logging",
                                    "magrittr", "parallel", "PredictiveEcology/fireSenseUtils@development (>= 0.0.5.9055)",
                                    "PredictiveEcology/pemisc@development", "PredictiveEcology/Require@development (>= 0.3.1)",
                                    "PredictiveEcology/SpaDES.tools@development (>= 2.0.4.9002)",
                                    "raster", "terra", "tidyr"),
            fireSense_dataPrepPredict = c("SpaDES.core",
                                          "data.table", "PredictiveEcology/fireSenseUtils@development (>= 0.0.5.9050)",
                                          "terra"),
            fireSense_IgnitionPredict = c("SpaDES.core", "magrittr",
                                          "PredictiveEcology/fireSenseUtils@development (>=0.0.4.9080)",
                                          "raster"),
            fireSense_EscapePredict = c("SpaDES.core", "magrittr",
                                        "raster", "stats"),
            fireSense_SpreadPredict = c("ggplot2",
                                        "magrittr", "Matrix", "methods", "PredictiveEcology/fireSenseUtils@development",
                                        "SpaDES.core", "stats", "terra", "viridis"))




# renv fails because of an unknown package, SpaDES.doc
Browse[1]> renv::install()
# Downloading packages -------------------------------------------------------
- Downloading Matrix from CRAN ...              OK [file is up to date]
- Downloading MASS from CRAN ...                OK [file is up to date]
- Downloading mgcv from CRAN ...                OK [file is up to date]
- Downloading nlme from CRAN ...                OK [file is up to date]
- Downloading LandR.CS from GitHub ...          OK [8 Kb in 1.0s]
- Downloading spatialEco from GitHub ...        OK [10.2 Mb in 3.3s]
- Downloading XML from CRAN ...                 OK [file is up to date]
Error: package 'SpaDES.docs' is not available



Browse[1]>       renv::install(exclude = "SpaDES.docs")
# Downloading packages -------------------------------------------------------
- Downloading Matrix from CRAN ...              OK [file is up to date]
- Downloading MASS from CRAN ...                OK [file is up to date]
- Downloading mgcv from CRAN ...                OK [file is up to date]
- Downloading nlme from CRAN ...                OK [file is up to date]
- Downloading LandR.CS from GitHub ...          OK [8 Kb in 1.0s]
- Downloading spatialEco from GitHub ...        OK [10.2 Mb in 12s]
- Downloading XML from CRAN ...                 OK [file is up to date]
Error: package 'SpaDES' is not available



### The DESCRIPTION file

```{r}
DESC = c("Package: simInitPkg", "Type: Package", "Title: simInitPkg", 
         "Version: 0.0.1", "Description: simInitPkg", "Date: 2024-02-20", 
         "Authors@R:  ", "  person(c(\"Eliot\", \"J\", \"B\"), \"McIntire\", email = \"eliot.mcintire@nrcan-rncan.gc.ca\", role = c(\"aut\", \"cre\"))", 
         "Imports:", "    archive,", "    assertthat,", "    compiler,", 
         "    crayon,", "    data.table (>= 1.15.0),", "    DEoptim,", 
         "    digest,", "    disk.frame,", "    dplyr,", "    fastdigest,", 
         "    fastDummies,", "    fasterize,", "    fpCompare,", "    future,", 
         "    geodata,", "    ggplot2,", "    ggpubr,", "    googledrive,", 
         "    grid,", "    gridExtra,", "    LandR.CS (>= 0.0.2.0002),", 
         "    PSPclean (>= 0.1.3.9003),", "    kSamples,", "    logging,", 
         "    magrittr,", "    MASS,", "    Matrix,", "    merTools,", 
         "    methods,", "    mgcv,", "    nlme,", "    numDeriv,", "    parallel,", 
         "    parallelly,", "    plyr,", "    climateData (>= 1.0.5),", 
         "    fireSenseUtils (>= 0.0.5.9056),", "    LandR (>= 1.1.0.9074),", 
         "    pemisc (>= 0.0.3.9002),", "    reproducible (>= 2.0.8.9012),", 
         "    Require (>= 0.3.1),", "    SpaDES.core (>= 2.0.2.9010),", 
         "    SpaDES.project (>= 0.0.8.9026),", "    SpaDES.tools (>= 2.0.4.9002),", 
         "    pryr,", "    purrr,", "    quickPlot,", "    R.utils,", 
         "    raster,", "    rasterVis,", "    Rcpp,", "    RCurl,", "    RhpcBLASctl,", 
         "    robustbase,", "    scales,", "    sf,", "    snow,", "    sp,", 
         "    spatialEco,", "    stats,", "    terra,", "    tidyr,", 
         "    viridis,", "    XML", "Suggests:", "    knitr,", "    rmarkdown", 
         "Remotes:", 
         "    PredictiveEcology/LandR@development,", 
         "    ianmseddy/LandR.CS@master,", 
         "    ianmseddy/PSPclean@development,", 
         "    PredictiveEcology/Require@development,", 
         "    PredictiveEcology/SpaDES.core@optionsAsArgs,", 
         "    PredictiveEcology/SpaDES.project@transition,", 
         "    PredictiveEcology/SpaDES.tools@development,", 
         "    PredictiveEcology/climateData@development,", 
         "    PredictiveEcology/fireSenseUtils@development,", 
         "    PredictiveEcology/pemisc@development,", 
         "    PredictiveEcology/reproducible@reproducibleTempCacheDir", 
         "Encoding: UTF-8", "License: GPL-3", "VignetteBuilder: knitr, rmarkdown", 
         "ByteCompile: yes", "Roxygen: list(markdown = TRUE)")
cat(DESC, file = "DESCRIPTION", append = FALSE)
```

# example fail using 
```{r,eval=FALSE}
options(renv.config.pak.enabled = FALSE)
renv::install(exclude = c("SpaDES.docs", "SpaDES"), upgrade = FALSE)
- Installing SpaDES.tools ...                   FAILED
Error: Error installing package 'SpaDES.tools':
========================================

Warning in untar2(tarfile, files, list, exdir, restore_times) :
  skipping pax global extended headers
* installing *source* package 'SpaDES.tools' ...
** using staged installation
** libs
using C++ compiler: 'G__~1.EXE (GCC) 12.2.0'
g++ -std=gnu++17  -I"C:/PROGRA~1/R/R-43~1.2/include" -DNDEBUG  -I'C:/Eliot/GitHub/Edehzhie/renv/staging/1/Rcpp/include'   -I"C:/rtools43/x86_64-w64-mingw32.static.posix/include"     -O2 -Wall  -mfpmath=sse -msse2 -mstackrealign  -c RcppExports.cpp -o RcppExports.o
g++ -std=gnu++17  -I"C:/PROGRA~1/R/R-43~1.2/include" -DNDEBUG  -I'C:/Eliot/GitHub/Edehzhie/renv/staging/1/Rcpp/include'   -I"C:/rtools43/x86_64-w64-mingw32.static.posix/include"     -O2 -Wall  -mfpmath=sse -msse2 -mstackrealign  -c duplicated.cpp -o duplicated.o
g++ -std=gnu++17  -I"C:/PROGRA~1/R/R-43~1.2/include" -DNDEBUG  -I'C:/Eliot/GitHub/Edehzhie/renv/staging/1/Rcpp/include'   -I"C:/rtools43/x86_64-w64-mingw32.static.posix/include"     -O2 -Wall  -mfpmath=sse -msse2 -mstackrealign  -c runif.cpp -o runif.o
g++ -std=gnu++17 -shared -s -static-libgcc -o SpaDES.tools.dll tmp.def RcppExports.o duplicated.o runif.o -LC:/rtools43/x86_64-w64-mingw32.static.posix/lib/x64 -LC:/rtools43/x86_64-w64-mingw32.static.posix/lib -LC:/PROGRA~1/R/R-43~1.2/bin/x64 -lR
installing to C:/Eliot/GitHub/Edehzhie/renv/staging/1/00LOCK-PredictiveEcology-SpaDES.tools-66efb34/00new/SpaDES.tools/libs/x64
** R
** inst
** byte-compile and prepare package for lazy loading
Error in loadNamespace(j <- i[[1L]], c(lib.loc, .libPaths()), versionCheck = vI[[j]]) : 
  namespace 'reproducible' 2.0.8.9015 is being loaded, but >= 2.0.9 is required
Calls: <Anonymous> ... namespaceImportFrom -> asNamespace -> loadNamespace
Execution halted
ERROR: lazy loading failed for package 'SpaDES.tools'
* removing 'C:/Eliot/GitHub/Edehzhie/renv/staging/1/SpaDES.tools'
install of package 'SpaDES.tools' failed [error code 1]
Warning message:
The 'yaml' package is required to parse dependencies within R Markdown files
Consider installing it with `install.packages("yaml")`. 
```


# example fail with pak via renv
```{r,eval=FALSE}
> options(renv.config.pak.enabled = TRUE)
> renv::install()
✔ Loading metadata database ... done                                       
Error:                                                                                                
! error in pak subprocess
Caused by error: 
! Could not solve package dependencies:
* deps::C:/Eliot/GitHub/Edehzhie: dependency conflict
Type .Last.error to see the more details.
```





```{r,eval=FALSE}

tf <- tempfile()
download.file("https://raw.githubusercontent.com/PredictiveEcology/LandR/LandWeb/DESCRIPTION", tf)
readLines(tf)
strsplit(read.dcf(tf, fields = "Remotes"), ",|,\n")[[1]]

pk <- pak::pkg_deps("PredictiveEcology/LandR@LandWeb")
pkgDep("PredictiveEcology/LandR@LandWeb")

pk2 <- pkgDep("PredictiveEcology/LandR@LandWeb", recursive = TRUE, Additional_repositories = T, purge = TRUE,
              which = c("Depends", "Imports"), includeBase = FALSE)[[1]]

pk3 <- sort(trimRedundancies(pk2$packageFullName)$packageFullName)

setdiff(trimVersionNumber(pk3), pk$ref)
setdiff(pk$ref, trimVersionNumber(pk3))

```


## default arguments -- `pkgDep(..., which = XX)` includes `LinkingTo`

`pkgDep`, by default, includes `LinkingTo` as these are required by `Rcpp` if that is required, and so are strictly necessary.
`pak::pkg_deps` does not include `LinkingTo` by default.

## default behaviour -- CRAN-preference

If there is no version specification, `pkgDep` prefers CRAN packages when there are multiple pointers to a package. Thus, even though a package may have a `Remotes` field pointint to e.g., `PredictiveEcology/SpaDES.tools@development`, if there is a recursive dependency within that package that specifies `SpaDES.tools` without a `Remotes` field, then `pkgDep` will return the `CRAN` version. If a user wants to override this behaviour, then the user can specify a version requirement that can only be satisfited with the `Remotes` option. Then `pkgDep` will take that.

`pak::pkg_deps` prefers the top-level specification, i.e., the non-recursive `Remotes` field will be returned, even if the same package is also specified within a recursive dependency without a `Remotes` field, i.e, if a recursive dependency points the CRAN package, it will not return that version of the dependency.


### `pak` fails for packages on GitHub that are not same name as Git Repo in Remotes

```{r,eval=FALSE}
gg <- pak::pkg_deps("PredictiveEcology/LandR@development", dependencies = TRUE)
# Error:                                                                                  
# ! error in pak subprocess
# Caused by error: 
# ! Could not solve package dependencies:
# * PredictiveEcology/LandR@development: Can't install dependency BioSIM
# * BioSIM: Can't find package called BioSIM.
# Type .Last.error to see the more details.
ff <- pkgDep("PredictiveEcology/LandR@development", dependencies = TRUE)
# $`PredictiveEcology/LandR@development`
#  [1] "BIEN"                                                  "RNCan/BioSimClient_R"
#  [3] "DBI (>= 0.8)"                                          "ENMeval"
#  [5] "Formula"                                               "Hmisc"
#  [7] "PredictiveEcology/LandR@development"                   "MatrixModels"
#  ...
```




```{r,eval=FALSE}
## minor errors of version number updating -- purrr 1.0.2 already installed
pak::pkg_install(pkgs)
                                                                          
→ Will install 16 packages.
→ Will update 1 package.
→ Will download 17 packages with unknown size.
+ colorspace           2.1-0 [dl]
+ fansi                1.0.6 [dl]
+ farver               2.1.1 [dl]
+ fpCompare            0.2.4 [bld][cmp][dl] (GitHub: a0260b8)
+ ggplot2              3.5.0 [dl]
+ gtable               0.3.4 [dl]
+ isoband              0.2.7 [dl]
+ labeling             0.4.3 [dl]
+ munsell              0.5.1 [dl]
+ pillar               1.9.0 [dl]
+ pkgconfig            2.0.3 [dl]
+ purrr        1.0.2 → 1.0.2 [dl]
+ RColorBrewer         1.1-3 [dl]
+ scales               1.3.0 [dl]
+ tibble               3.2.1 [dl]
+ utf8                 1.2.4 [dl]
+ viridisLite          0.4.2 [dl]

! purrr is loaded in the current R session, you probably need to restart R
after the installation.

? Do you want to continue (Y/n) 

```
