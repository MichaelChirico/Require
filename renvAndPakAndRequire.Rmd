---
output: html_document
editor_options: 
  chunk_output_type: console
---
## pak
- when it fails due to "dependency conflict", there is no way to diagnose
- seems to work if there is only one "branch" for each given package, but not multiple branches e.g., `c("PredictiveEcology/reproducible@development", "PredictiveEcology/reproducible")`, but 
it is not clear why ... are their dependencies conflicting or is it just the package
- can't write version numbers at the command line, though they can exist in a DESCRIPTION file
```{r}
pak::pkg_install(
  c("PredictiveEcology/reproducible@development", 
    "PredictiveEcology/reproducible"))
# Error:                                                                                 
# ! error in pak subprocess
# Caused by error: 
# ! Could not solve package dependencies:
# * PredictiveEcology/reproducible@development: Conflicts with PredictiveEcology/reproducible
# * PredictiveEcology/reproducible: Conflicts with PredictiveEcology/reproducible@development
# Type .Last.error to see the more details.


# FAILS
pak::pkg_install(
  c("PredictiveEcology/reproducible@development", 
    "PredictiveEcology/reproducible"))

# FAILS
pak::pkg_install(
    c("PredictiveEcology/reproducible@modsForLargeArchives (>=2.0.10.9010)", 
      "PredictiveEcology/reproducible (>= 2.0.10)"))

# FAILS
pak::pkg_install("local://~/GitHub/Edehzhie/DESCRIPTION")

# Installs or does nothing is `reproducible` already installed
Require::Install(
  c("PredictiveEcology/reproducible@development", 
    "PredictiveEcology/reproducible"))

# Fine -- picks the more recent version number and installs
Require::Install(
    c("PredictiveEcology/reproducible@modsForLargeArchives (>=2.0.10.9010)", 
      "PredictiveEcology/reproducible (>= 2.0.10)"))
```

## pak

Fails when there are 2 branches within a DESCRIPTION -- wants to downgrade, regardless of order
```{r}
# Installs or does nothing is `reproducible` already installed
Require::Install(
  c("PredictiveEcology/reproducible@development", 
    "PredictiveEcology/reproducible"))

DESC <- c("Package: temp", "Type: Package", "Title: Temp", "Version: 0.0.1", 
          "Description: Eliot McIntire", "Date: 2024-02-20", "Authors@R:  ", 
          "  NULL", "Imports:", "    reproducible", "Suggests:", "    knitr,", 
          "    rmarkdown", "Remotes:", "    PredictiveEcology/reproducible,", 
          "    PredictiveEcology/reproducible@development", "Encoding: UTF-8", 
          "License: GPL-3", "VignetteBuilder: knitr, rmarkdown", "ByteCompile: yes", 
          "Roxygen: list(markdown = TRUE)")
cat(DESC, file = "DESCRIPTION")
pak::local_install_deps("~/GitHub/Edehzhie/")
                                                                                       
# → Will update 1 package.
# → All 2 packages (0 B) are cached.
# + reproducible 2.0.10.9018 → 2.0.10 [bld][cmp] (GitHub: 014d1de)



# Fails when adding the version number specification because internally trims the branch
DESC <- c("Package: temp", "Type: Package", "Title: Temp", "Version: 0.0.1", 
          "Description: Eliot McIntire", "Date: 2024-02-20", "Authors@R:  ", 
          "  NULL", "Imports:", "    reproducible (>= 2.0.10.9010)", "Suggests:", 
          "    knitr,", "    rmarkdown", "Remotes:", "    PredictiveEcology/reproducible,", 
          "    PredictiveEcology/reproducible@modsForLargeArchives", "Encoding: UTF-8", 
          "License: GPL-3", "VignetteBuilder: knitr, rmarkdown", "ByteCompile: yes", 
          "Roxygen: list(markdown = TRUE)")
cat(DESC, file = "DESCRIPTION")
pak::local_install_deps("~/GitHub/Edehzhie/")
# Error:                                                                      
# ! error in pak subprocess
# Caused by error: 
# ! Could not solve package dependencies:
# * deps::C:/Eliot/GitHub/Edehzhie: Can't install dependency PredictiveEcology/reproducible (>= 2.0.10.9010)
# Type .Last.error to see the more details.
```

## renv
- doesn't install packages that have been removed from CRAN (SpaDES)
- finds packages that other package dependencies don't find (SpaDES.docs)
- slow to download
- hijack
- when fails, can't pick up where it left off
- fails to install e.g., reproducible if it insufficient version, even if nothing is loaded
- relies so heavily on DESCRIPTION that e.g., `install.packages("reproducible")` will not install
reproducible from CRAN if there is a `Remotes` pointing to e.g., `PredictiveEcology/reproducible@reproducibleTempCacheDir`


# These are not the same ... why?
bb <- c("DEoptim", "PredictiveEcology/LandR@development (>= 1.1.0.9074)",
        "ianmseddy/LandR.CS@master (>= 0.0.2.0002)", "MASS", "Matrix",
        "ianmseddy/PSPclean@development (>= 0.1.3.9003)", "R.utils",
        "RCurl", "Rcpp", "PredictiveEcology/Require@development (>= 0.3.1)",
        "RhpcBLASctl", "PredictiveEcology/SpaDES.core@optionsAsArgs (>= 2.0.2.9010)",
        "PredictiveEcology/SpaDES.project@transition (>= 0.0.8.9026)",
        "PredictiveEcology/SpaDES.tools@development (>= 2.0.4.9002)",
        "XML", "archive", "assertthat", "PredictiveEcology/climateData@development (>= 1.0.5)",
        "compiler", "crayon", "data.table (>= 1.15.0)", "digest", "disk.frame",
        "dplyr", "fastDummies", "fastdigest", "fasterize", "PredictiveEcology/fireSenseUtils@development (>= 0.0.5.9056)",
        "fpCompare", "future", "geodata", "ggplot2", "ggpubr", "googledrive",
        "grid", "gridExtra", "kSamples", "logging", "magrittr", "merTools",
        "methods", "mgcv", "nlme", "numDeriv", "parallel", "parallelly",
        "PredictiveEcology/pemisc@development (>= 0.0.3.9002)", "plyr",
        "pryr", "purrr", "quickPlot", "raster", "rasterVis", "PredictiveEcology/reproducible@reproducibleTempCacheDir (>= 2.0.8.9012)",
        "robustbase", "scales", "sf", "snow", "sp", "spatialEco", "stats",
        "terra", "tidyr", "viridis")
a <- pkgDep(bb, recursive = TRUE)
b <- unlist(lapply(bb, pkgDep, recursive = TRUE), recursive = FALSE)
all.equal(b$`PredictiveEcology/LandR@development (>= 1.1.0.9074)`, a$`PredictiveEcology/LandR@development (>= 1.1.0.9074)`)






bbb <- list(canClimateData = c("SpaDES.core", "archive", "digest", "geodata",
                               "googledrive", "PredictiveEcology/climateData@development (>= 1.0.5)",
                               "PredictiveEcology/fireSenseUtils@development (>= 0.0.5.9046)",
                               "PredictiveEcology/LandR@development (>= 1.1.0.9064)", "PredictiveEcology/reproducible@development (>= 2.0.8.9001)",
                               "PredictiveEcology/SpaDES.tools@development (>= 2.0.4.9002)",
                               "purrr", "R.utils", "sf", "spatialEco", "terra"),
            fireSense_dataPrepFit = c("data.table (>= 1.15.0)",
                                      "fastDummies", "ggplot2", "parallel", "PredictiveEcology/fireSenseUtils@development (>= 0.0.5.9056)",
                                      "PredictiveEcology/LandR@development (>= 1.1.0.9073)", "PredictiveEcology/SpaDES.core@development (>= 2.0.2.9006)",
                                      "PredictiveEcology/SpaDES.project@transition", "PredictiveEcology/SpaDES.tools (>= 2.0.4.9002)",
                                      "purrr", "raster", "sf", "snow", "sp", "spatialEco", "terra"),
            Biomass_borealDataPrep = c("assertthat", "crayon", "data.table",
                                       "dplyr", "fasterize", "ggplot2", "merTools", "plyr", "PredictiveEcology/LandR@development (>= 1.1.0.9054)",
                                       "PredictiveEcology/pemisc@development", "PredictiveEcology/reproducible@development (>= 2.0.8.9005)",
                                       "PredictiveEcology/SpaDES.core@development (>= 2.0.2.9004)",
                                       "PredictiveEcology/SpaDES.project@transition (>= 0.0.8.9026)",
                                       "rasterVis", "sf", "SpaDES.tools (>= 2.0.0)", "terra"),
            Biomass_core = c("assertthat",
                             "compiler", "crayon", "data.table", "dplyr", "fpCompare",
                             "ggplot2", "grid", "ianmseddy/LandR.CS@master (>= 0.0.2.0002)",
                             "parallel", "PredictiveEcology/LandR@development (>= 1.1.0.9006)",
                             "PredictiveEcology/pemisc@development", "PredictiveEcology/reproducible@development",
                             "PredictiveEcology/SpaDES.core@development (>= 2.0.2.9004)",
                             "PredictiveEcology/SpaDES.tools@development (>= 1.0.0.9001)",
                             "purrr", "quickPlot", "R.utils", "Rcpp", "scales", "terra",
                             "tidyr"),
            Biomass_speciesData = c("data.table", "PredictiveEcology/LandR@development (>= 1.1.0.9074)",
                                    "PredictiveEcology/pemisc@development", "PredictiveEcology/reproducible@reproducibleTempCacheDir (>= 2.0.8.9012)",
                                    "PredictiveEcology/SpaDES.core@development (>= 2.0.2.9004)",
                                    "PredictiveEcology/SpaDES.tools@development (>= 1.0.2)",
                                    "pryr", "RCurl", "sf", "terra", "XML"),
            Biomass_speciesFactorial = c("crayon",
                                         "ggplot2", "PredictiveEcology/LandR@development (>= 1.0.7.9025)",
                                         "PredictiveEcology/SpaDES.core@optionsAsArgs (>= 2.0.2.9010)",
                                         "PredictiveEcology/SpaDES.project (>= 0.0.7.9013)", "terra",
                                         "viridis"),
            Biomass_speciesParameters = c("crayon", "data.table",
                                          "disk.frame", "fpCompare", "ggplot2", "gridExtra", "ianmseddy/PSPclean@development (>= 0.1.3.9003)",
                                          "magrittr", "mgcv", "nlme", "PredictiveEcology/LandR@development (>= 1.1.0.9054)",
                                          "PredictiveEcology/pemisc@development (>= 0.0.3.9002)", "PredictiveEcology/reproducible@development (>= 1.2.10.9001)",
                                          "PredictiveEcology/SpaDES.core@development (>= 2.0.2.9004)",
                                          "purrr", "robustbase", "sf"),
            fireSense_IgnitionFit = c("data.table",
                                      "DEoptim", "dplyr", "ggplot2", "ggpubr", "magrittr", "MASS",
                                      "numDeriv", "parallel", "parallelly", "PredictiveEcology/fireSenseUtils@terra-migration (>= 0.0.5.9045)",
                                      "PredictiveEcology/pemisc@development", "PredictiveEcology/reproducible@development (>= 2.0.8.9005)",
                                      "PredictiveEcology/SpaDES.core@development (>= 2.0.2.9006)",
                                      "RhpcBLASctl", "terra"),
            fireSense_EscapeFit = "SpaDES.core",
            fireSense_SpreadFit = c("SpaDES.core", "data.table", "DEoptim",
                                    "fastdigest", "future", "ggplot2", "kSamples", "logging",
                                    "magrittr", "parallel", "PredictiveEcology/fireSenseUtils@development (>= 0.0.5.9055)",
                                    "PredictiveEcology/pemisc@development", "PredictiveEcology/Require@development (>= 0.3.1)",
                                    "PredictiveEcology/SpaDES.tools@development (>= 2.0.4.9002)",
                                    "raster", "terra", "tidyr"),
            fireSense_dataPrepPredict = c("SpaDES.core",
                                          "data.table", "PredictiveEcology/fireSenseUtils@development (>= 0.0.5.9050)",
                                          "terra"),
            fireSense_IgnitionPredict = c("SpaDES.core", "magrittr",
                                          "PredictiveEcology/fireSenseUtils@development (>=0.0.4.9080)",
                                          "raster"),
            fireSense_EscapePredict = c("SpaDES.core", "magrittr",
                                        "raster", "stats"),
            fireSense_SpreadPredict = c("ggplot2",
                                        "magrittr", "Matrix", "methods", "PredictiveEcology/fireSenseUtils@development",
                                        "SpaDES.core", "stats", "terra", "viridis"))




# renv fails because of an unknown package, SpaDES.doc
Browse[1]> renv::install()
# Downloading packages -------------------------------------------------------
- Downloading Matrix from CRAN ...              OK [file is up to date]
- Downloading MASS from CRAN ...                OK [file is up to date]
- Downloading mgcv from CRAN ...                OK [file is up to date]
- Downloading nlme from CRAN ...                OK [file is up to date]
- Downloading LandR.CS from GitHub ...          OK [8 Kb in 1.0s]
- Downloading spatialEco from GitHub ...        OK [10.2 Mb in 3.3s]
- Downloading XML from CRAN ...                 OK [file is up to date]
Error: package 'SpaDES.docs' is not available



Browse[1]>       renv::install(exclude = "SpaDES.docs")
# Downloading packages -------------------------------------------------------
- Downloading Matrix from CRAN ...              OK [file is up to date]
- Downloading MASS from CRAN ...                OK [file is up to date]
- Downloading mgcv from CRAN ...                OK [file is up to date]
- Downloading nlme from CRAN ...                OK [file is up to date]
- Downloading LandR.CS from GitHub ...          OK [8 Kb in 1.0s]
- Downloading spatialEco from GitHub ...        OK [10.2 Mb in 12s]
- Downloading XML from CRAN ...                 OK [file is up to date]
Error: package 'SpaDES' is not available



### The DESCRIPTION file

```{r}
DESC = c("Package: simInitPkg", "Type: Package", "Title: simInitPkg", 
         "Version: 0.0.1", "Description: simInitPkg", "Date: 2024-02-20", 
         "Authors@R:  ", "  person(c(\"Eliot\", \"J\", \"B\"), \"McIntire\", email = \"eliot.mcintire@nrcan-rncan.gc.ca\", role = c(\"aut\", \"cre\"))", 
         "Imports:", "    archive,", "    assertthat,", "    compiler,", 
         "    crayon,", "    data.table (>= 1.15.0),", "    DEoptim,", 
         "    digest,", "    disk.frame,", "    dplyr,", "    fastdigest,", 
         "    fastDummies,", "    fasterize,", "    fpCompare,", "    future,", 
         "    geodata,", "    ggplot2,", "    ggpubr,", "    googledrive,", 
         "    grid,", "    gridExtra,", "    LandR.CS (>= 0.0.2.0002),", 
         "    PSPclean (>= 0.1.3.9003),", "    kSamples,", "    logging,", 
         "    magrittr,", "    MASS,", "    Matrix,", "    merTools,", 
         "    methods,", "    mgcv,", "    nlme,", "    numDeriv,", "    parallel,", 
         "    parallelly,", "    plyr,", "    climateData (>= 1.0.5),", 
         "    fireSenseUtils (>= 0.0.5.9056),", "    LandR (>= 1.1.0.9074),", 
         "    pemisc (>= 0.0.3.9002),", "    reproducible (>= 2.0.8.9012),", 
         "    Require (>= 0.3.1),", "    SpaDES.core (>= 2.0.2.9010),", 
         "    SpaDES.project (>= 0.0.8.9026),", "    SpaDES.tools (>= 2.0.4.9002),", 
         "    pryr,", "    purrr,", "    quickPlot,", "    R.utils,", 
         "    raster,", "    rasterVis,", "    Rcpp,", "    RCurl,", "    RhpcBLASctl,", 
         "    robustbase,", "    scales,", "    sf,", "    snow,", "    sp,", 
         "    spatialEco,", "    stats,", "    terra,", "    tidyr,", 
         "    viridis,", "    XML", "Suggests:", "    knitr,", "    rmarkdown", 
         "Remotes:", 
         "    PredictiveEcology/LandR@development,", 
         "    ianmseddy/LandR.CS@master,", 
         "    ianmseddy/PSPclean@development,", 
         "    PredictiveEcology/Require@development,", 
         "    PredictiveEcology/SpaDES.core@optionsAsArgs,", 
         "    PredictiveEcology/SpaDES.project@transition,", 
         "    PredictiveEcology/SpaDES.tools@development,", 
         "    PredictiveEcology/climateData@development,", 
         "    PredictiveEcology/fireSenseUtils@development,", 
         "    PredictiveEcology/pemisc@development,", 
         "    PredictiveEcology/reproducible@reproducibleTempCacheDir", 
         "Encoding: UTF-8", "License: GPL-3", "VignetteBuilder: knitr, rmarkdown", 
         "ByteCompile: yes", "Roxygen: list(markdown = TRUE)")
cat(DESC, file = "DESCRIPTION", append = FALSE)
```

# example fail using 
```{r}
options(renv.config.pak.enabled = FALSE)
renv::install(exclude = c("SpaDES.docs", "SpaDES"), upgrade = FALSE)
- Installing SpaDES.tools ...                   FAILED
Error: Error installing package 'SpaDES.tools':
========================================

Warning in untar2(tarfile, files, list, exdir, restore_times) :
  skipping pax global extended headers
* installing *source* package 'SpaDES.tools' ...
** using staged installation
** libs
using C++ compiler: 'G__~1.EXE (GCC) 12.2.0'
g++ -std=gnu++17  -I"C:/PROGRA~1/R/R-43~1.2/include" -DNDEBUG  -I'C:/Eliot/GitHub/Edehzhie/renv/staging/1/Rcpp/include'   -I"C:/rtools43/x86_64-w64-mingw32.static.posix/include"     -O2 -Wall  -mfpmath=sse -msse2 -mstackrealign  -c RcppExports.cpp -o RcppExports.o
g++ -std=gnu++17  -I"C:/PROGRA~1/R/R-43~1.2/include" -DNDEBUG  -I'C:/Eliot/GitHub/Edehzhie/renv/staging/1/Rcpp/include'   -I"C:/rtools43/x86_64-w64-mingw32.static.posix/include"     -O2 -Wall  -mfpmath=sse -msse2 -mstackrealign  -c duplicated.cpp -o duplicated.o
g++ -std=gnu++17  -I"C:/PROGRA~1/R/R-43~1.2/include" -DNDEBUG  -I'C:/Eliot/GitHub/Edehzhie/renv/staging/1/Rcpp/include'   -I"C:/rtools43/x86_64-w64-mingw32.static.posix/include"     -O2 -Wall  -mfpmath=sse -msse2 -mstackrealign  -c runif.cpp -o runif.o
g++ -std=gnu++17 -shared -s -static-libgcc -o SpaDES.tools.dll tmp.def RcppExports.o duplicated.o runif.o -LC:/rtools43/x86_64-w64-mingw32.static.posix/lib/x64 -LC:/rtools43/x86_64-w64-mingw32.static.posix/lib -LC:/PROGRA~1/R/R-43~1.2/bin/x64 -lR
installing to C:/Eliot/GitHub/Edehzhie/renv/staging/1/00LOCK-PredictiveEcology-SpaDES.tools-66efb34/00new/SpaDES.tools/libs/x64
** R
** inst
** byte-compile and prepare package for lazy loading
Error in loadNamespace(j <- i[[1L]], c(lib.loc, .libPaths()), versionCheck = vI[[j]]) : 
  namespace 'reproducible' 2.0.8.9015 is being loaded, but >= 2.0.9 is required
Calls: <Anonymous> ... namespaceImportFrom -> asNamespace -> loadNamespace
Execution halted
ERROR: lazy loading failed for package 'SpaDES.tools'
* removing 'C:/Eliot/GitHub/Edehzhie/renv/staging/1/SpaDES.tools'
install of package 'SpaDES.tools' failed [error code 1]
Warning message:
The 'yaml' package is required to parse dependencies within R Markdown files
Consider installing it with `install.packages("yaml")`. 
```


# example fail with pak via renv
```{r}
> options(renv.config.pak.enabled = TRUE)
> renv::install()
✔ Loading metadata database ... done                                       
Error:                                                                                                
! error in pak subprocess
Caused by error: 
! Could not solve package dependencies:
* deps::C:/Eliot/GitHub/Edehzhie: dependency conflict
Type .Last.error to see the more details.
```



# installing packages that have been archived

```{r}
Require::Install("RandomFields")
# packaged installation of 'RandomFields' as RandomFields_3.3.14.zip
# * DONE (RandomFields)
# .....
# packaged installation of 'RandomFieldsUtils' as RandomFieldsUtils_1.2.5.zip
# * DONE (RandomFieldsUtils)
# 
# The downloaded source packages are in
# 	‘C:\Users\emcintir\AppData\Local\Temp\RtmpSqWkiA\downloaded_packages’

pak::pkg_install(c("RandomFields", "RandomFieldsUtils"))
# ✔ Updated metadata database: 5.18 MB in 9 files.                          
# ✔ Updating metadata database ... done                                     
# Error:                                                                     
# ! error in pak subprocess
# Caused by error: 
# ! Could not solve package dependencies:
# * RandomFields: Can't find package called RandomFields.
# * RandomFieldsUtils: Can't find package called RandomFieldsUtils.
```



```{r}

tf <- tempfile()
download.file("https://raw.githubusercontent.com/PredictiveEcology/LandR/LandWeb/DESCRIPTION", tf)
readLines(tf)
strsplit(read.dcf(tf, fields = "Remotes"), ",|,\n")[[1]]

pk <- pak::pkg_deps("PredictiveEcology/LandR@LandWeb")

pk2 <- pkgDep("PredictiveEcology/LandR@LandWeb", recursive = TRUE, Additional_repositories = T, purge = TRUE,
              which = c("Depends", "Imports"), includeBase = FALSE)[[1]]

pk3 <- sort(trimRedundancies(pk2$packageFullName)$packageFullName)

setdiff(trimVersionNumber(pk3), pk$ref)
setdiff(pk$ref, trimVersionNumber(pk3))

```


## default arguments -- `pkgDep(..., which = XX)` includes `LinkingTo`

`pkgDep`, by default, includes `LinkingTo` as these are required by `Rcpp` if that is required, and so are strictly necessary.
`pak::pkg_deps` does not include `LinkingTo` by default.

## default behaviour -- CRAN-preference

If there is no version specification, `pkgDep` prefers CRAN packages when there are multiple pointers to a package. Thus, even though a package may have a `Remotes` field pointint to e.g., `PredictiveEcology/SpaDES.tools@development`, if there is a recursive dependency within that package that specifies `SpaDES.tools` without a `Remotes` field, then `pkgDep` will return the `CRAN` version. If a user wants to override this behaviour, then the user can specify a version requirement that can only be satisfited with the `Remotes` option. Then `pkgDep` will take that.

`pak::pkg_deps` prefers the top-level specification, i.e., the non-recursive `Remotes` field will be returned, even if the same package is also specified within a recursive dependency without a `Remotes` field, i.e, if a recursive dependency points the CRAN package, it will not return that version of the dependency.
